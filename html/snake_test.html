<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8>
    <title>Snake</title>
    <script src="libs/three.js"></script>
    <script src="libs/stats.js"></script>
    <script src="libs/dat.gui.js"></script>
    <script src="libs/jquery-1.12.4.js"></script>
    <script src="libs/Tween.js"></script>
    <script src="libs/vue.min.js"></script>
    <script src="snake.js"></script>

    <style>
     .scoreboard-flag {
         height: 4em;
         width: 100%;
         fill: #797784;
     }

     body {
         font-family: 'Montserrat', sans-serif
         margin: 0px;
         overflow: hidden;
         background: #6a6676;
         color: white;
     }

     #snake-board {
         position: absolute;
         top: 0px;
         left: 0px;
         bottom: 0px;
         right: 410px;
     }

     #scoreboard-panel {
         position: absolute;
         top: 10px;
         width: 400px;
         right: 10px;
         bottom: 10px;
     }

     .scoreboard-game-info {
         margin-left: 5px;
         margin-top: 5px;
         margin-bottom: 5px;
     }

     .scoreboard-flag {
         height: 5em;
     }

     #snake-info-list {
         position: absolute;
         top: 150px;
         width: 400px;
         right: 10px;
         bottom: 10px;
     }

     .snake-info {
         position: absolute;
         width: 400px;
         top: 150px;
         right: 10px;
         /*
            border: 5px solid blue;
            border-radius: 15px;
            margin-bottom: 10px;
            padding: 5px;
            background: white;
            box-shadow: 6px 6px 6px rgba(0, 0, 0, .5);
          */
     }

     .noborder {
         border: none;
     }

     #snake-info-template {
         display: none;
     }

     .snake-info-right {
         margin-left: 10px;
         width: 300px;
     }

     .snake-info-health-border {
         position: relative;
         left: 0px;
         right: 0px;
         height: 40px;
     }

     .snake-info-health-background {
         position: absolute;
         left: 0px;
         top: 0px;
         bottom: 0px;
         right: 0px;
         background: green;
         opacity: 0.3;
     }

     .snake-info-health {
         position: absolute;
         left: 0px;
         top: 0px;
         bottom: 0px;
         background: green;
         width: 35%;
     }

     .snake-info-name {
         color: white;
         font-weight: bold;
     }

     .snake-info-taunt {
         position: absolute;
         overflow: hidden;
         color: white;
         z-index: 10;
         line-height: 40px;
         top: 0px;
         bottom: 0px;
         margin-left: 10px;
     }

     .snake-info-img {
         width: 64px;
         height: 64px;
     }

    </style>
  </head>

  <body>
    <div id="snake-board"></div>

    <div id="scoreboard-panel">

      <div id="scoreboard-logo">
	<img src="/images/bs-logo-light.svg"/>
      </div>

      <div id="scoreboard-game-info" class="scoreboard-game-info-wrapper">
	<div class="scoreboard-game-info">
	  <div>
            <span>{{game_name}}</span>
	  </div>
	  <div>
            <span>Turn</span>
            <span>{{game_turn}}</span>
	  </div>
	</div>
      </div>

    </div>

    <div id="snake-info-list"></div>

    <!-- snake-info-block-template -->
    <div class="snake-info" id="snake-info-template" v-bind:style="{'border-color': color}">
      <table width="100%" cellspacing="0" cellpadding="0">
        <tr>
          <td class="noborder" valign="top" width="64px"><img class="snake-info-img" v-bind:src="img"/></td>
          <td class="noborder" valign="top" width="100%">
            <div class="snake-info-right">
              <div class="snake-info-name">{{name}}</div>
              <div class="snake-info-health-border">
                <div class="snake-info-health-background"  v-bind:style="{'background': color}"></div>
                <div class="snake-info-health" v-bind:style="{width: health + '%', 'background': color}"></div>
	        <div class="snake-info-taunt">{{taunt}}</div>
              </div>
            </div>
          </td>
        </tr>
      </table>
    </div>


    <script>
     var game_renderer;

     function init() {
         game_renderer = new BattleSnakes.GameRenderer("#snake-board", "#snake-info-list");

         var game_data;
         var game_turn_data;
         var game_turn_index;
         var snake_defaults;
         var GAME_TURN_FPS = 20;

         function render_turn() {
             if( !game_turn_data ) {
                 return;
             }

             game_turn_index++;
             game_turn_index %= game_turn_data.length;
             var board = game_turn_data[game_turn_index];
             for(var snake_i=0; snake_i<board.snakes.length; snake_i++) {
                 var snake = board.snakes[snake_i];
                 var snake_default = snake_defaults[snake.board_id];
                 for(var key in snake_default) {
                     if( !(key in snake) ) {
                         snake[key] = snake_default[key];
                     }
                 }
             }

             game_renderer.render(board);

             setTimeout(render_turn, 1000 / GAME_TURN_FPS);
         }

         function stringToColor(str) {
             // when you can't pick a color, hash a string
             var hash = 0;
             for (var i = 0; i < str.length; i++) {
                 hash = str.charCodeAt(i) + ((hash << 5) - hash);
             }
             var color = '#';
             for (var i = 0; i < 3; i++) {
                 var value = (hash >> (i * 8)) & 0xFF;
                 color += ('00' + value.toString(16)).substr(-2);
             }
             return color;
         }

         function load_game(url) {
             // load the game.  When loaded, set game_dirty
             $.getJSON(url, function(data) {
                 game_data = data;

                 snake_defaults = {};
                 var snakes = game_data["snakes"];
                 for(var i=0; i<snakes.length; i++) {
                     var snake = snakes[i];
                     if( (!("taunt" in snake)) && ("func" in snake) ) {
                         snake.taunt = snake.func;
                     }
                     if( !("id" in snake) ) {
                         snake.id = snake.board_id;
                     }
                     if( !("color" in snake) ) {
                         snake.color = stringToColor(snake.taunt);
                     }

                     snake_defaults[snake.board_id] = snake;
                 }

                 game_turn_data = data["turns"];
                 game_turn_index = -1;

                 render_turn();
             });
         }

         load_game("game.json");
     }
     window.onload = init;

     function resize() {
         if( game_renderer ) {
             game_renderer.resize();
         }
     }
     window.addEventListener('resize', resize, false);

    </script>
  </body>
</html>
