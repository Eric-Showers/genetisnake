<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8>
    <title>Snakes!</title>
    <script src="https://code.jquery.com/jquery-3.1.1.js"></script>
    <script src="libs/three.js"></script>
    <script src="libs/TrackballControls.js"></script>
    <script src="libs/stats.js"></script>
    <script src="libs/dat.gui.js"></script>
    <script src="libs/jquery-1.12.4.js"></script>
    <script src="libs/jquery.splitter-0.14.0.js"></script>
    <link href="libs/jquery.splitter.css" rel="stylesheet"/>
    <script src="libs/datatables.js"></script>
    <link href="libs/datatables.css" rel="stylesheet"/>
    <script src="libs/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
    <link href="libs/jquery-ui-1.12.1.custom/jquery-ui.css" rel="stylesheet"/>
    <script src="libs/Tween.js"></script>
    <style>
     body {
         margin: 0px;
         overflow: hidden;
     }
     
     #main_pane {
         position: absolute;
         top: 0px;
         left: 0px;
         bottom: 0px;
         right: 0px;
     }

     #board_pane {
         position: absolute;
         top: 0px;
         left: 0px;
         bottom: 0px;
         width: 60%;
     }
     
     #scene_and_hud_pane {
         overflow: hidden;
         position: absolute;
         top: 0px;
         left: 0px;
         bottom: 200px;
         right: 0px;
     }

     #scene_pane {
         overflow: hidden;
         position: absolute;
         top: 0px;
         left: 0px;
         bottom: 0px;
         right: 0px;
     }

     #right_pane {
     }

     #right_inner {
         margin-right: 10px;
         margin-left: 10px;
     }
     
     #control_panel {
         margin-left: 10px;
         margin-right: 10px;
     }
     
     #play_controls {
         display: flex;
         width: 100%;
         align-items: center;
         margin-top: 50px;
     }

     #play_slider {
         flex-grow: 1;
         margin-left: 15px;
         margin-right: 15px;
     }
     
     #snake-info-list {
         position: absolute; 
         top: 10px;
         width: 300px;
         right: 10px;
         bottom: 10px;
         z-index: 99;
     }

     .snake-info-block {
         position: absolute;
         border: 2px solid blue;
         border-radius: 15px;
         margin-bottom: 10px;
         padding: 10px;
         background: white;
         box-shadow: 6px 6px 6px rgba(128, 128, 128, .5);
     }

     #snake-info-block-template {
         display: none;
     }
     
     .snake-info-group {
         margin-left: 10px;
         width: 85%;
     }
     
     .snake-health-border {
         height: 10px;
         background-color: white;
         border: 1px solid black;
         left: 0px;
         right: 0px;
     }

     .snake-health {
         height: 10px;
         background-color: green;
         left: 0px;
     }
     
     .snake-name {
         font-weight: bold;
     }

     .snake-taunt {
         overflow: hidden;
         height: 20px;
     }
     
     .snake-img {
         width: 64px;
         height: 64px;
     }
    </style>
  </head>
  
  <body>
    <div id="main_pane">
      <div id="board_pane">
        <div id="scene_and_hud_pane">
          <div id="scene_pane"></div>

          <div id="hud_pane">
            <div id="snake-info-list"></div>
            
            <!-- snake-info-block-template -->
            <div class="snake-info-block snake-color" id="snake-info-block-template">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td valign="top"><img class="snake-img" src="snake1.jpg"/></td>
                  <td valign="top" width="100%">
                    <div class="snake-info-group">
                      <div class="snake-name">{{item.name}}</div>
                      <div class="snake-health-border">
                        <div class="snake-health" style="width: 100%;"></div>
                      </div>
                      <div class="snake-turns-killed">
                        Turns: <span class="snake-turns"></span>
                        <span class="snake-killed"></span>
                      </div>
                      <div class="snake-taunt"></div>
                    </div>
                  </td>
                </tr>
              </table>
            </div>
            
          </div>
        </div>
        <div id="control_panel">
          <div id="play_controls">
            <input type="checkbox" id="play_button" checked/><label for="play_button">Playing</label>
            <div id="play_slider" width="100%"></div>
          </div>
        </div>
      </div>
      <div id="right_pane">
        <div id="right_inner">
          <h1>Snakes!</h1>
          <img src="training/turns.svg"/>
          <table id="games_table" class="display" cellspacing="0" width="100%" height="100%"></table>
        </div>
      </div>
    </div>
    
    <script>

     function SnakeInfoBlock(id, data) {
         var self = this;
         self.id = id;
         
         function init(data) {
             var template = $('#snake-info-block-template');
             var el = template.clone().prop('id', self.id);
             template.parent().append(el);
             if( data ) {
                 self.set(data);
             }
             el.show();
         }

         self.el = function(sub) {
             var sel = '#' + self.id
             if( sub ) {
                 sel += ' ' + sub;
             }
             return $(sel);
         }
         
         self.set = function(data) {
             if( 'name' in data ) {
                 self.el('.snake-name').text(data.name);
             }
             if( 'taunt' in data ) {
                 self.el('.snake-taunt').text(data.taunt);
             }
             if( 'health' in data ) {
                 self.el('.snake-health').css('width', '' + data.health + '%');
             }
             if( 'color' in data ) {
                 self.el().css('background', data.color);
             }
             if( 'img' in data ) {
                 self.el('.snake-img').prop('src', data.img);
             }
             if( 'killed' in data ) {
                 self.el('.snake-killed').text(data.killed);
             }
             if( 'turns' in data ) {
                 self.turns = data.turns;
                 self.el('.snake-turns').text(data.turns);
                 self.el('.snake-turns-killed').css('visibility', data.turns ? "visible" : "hidden");
             }
         }

         self.remove = function() {
             self.el().remove();
         }

         init();
     }
     
     var game;

     var renderer;
     var camera;
     var scene;

     function init() {
         var controls = new function() {
             this.pointLightIntensity = .6;
         }

         var gui = new dat.GUI();
         gui.add(controls, 'pointLightIntensity', 0, 3).onChange(function(e) {
             pointLight.intensity = e;
         });

         var clock = new THREE.Clock();
         scene = new THREE.Scene();

         var scene_pane = $("#scene_pane");
         var innerWidth = scene_pane.innerWidth();
         var innerHeight = scene_pane.innerHeight();

         camera = new THREE.PerspectiveCamera(45, innerWidth / innerHeight, 0.1, 1000);
         camera.position.set(0, 0, 30);
         camera.lookAt(scene.position);

         renderer = new THREE.WebGLRenderer();
         renderer.setClearColor(0xffffff, 1.0);
         renderer.setSize(innerWidth, innerHeight);
         //renderer.shadowMap.Enabled = true;
         renderer.domElement.style.position = 'absolute';
         renderer.domElement.style.zIndex = 0;
         renderer.domElement.style.top = 0;
         renderer.domElement.style.bottom = 0;
         renderer.domElement.style.left = 0;
         renderer.domElement.style.right = 0;

         var trackballControls = new THREE.TrackballControls(camera, document.getElementById("scene_pane"));
         trackballControls.rotateSpeed = 1.0;
         trackballControls.zoomSpeed = 1.0;
         trackballControls.panSpeed = 1.0;
         trackballControls.staticMoving = true;
         
         var spotLight = new THREE.SpotLight(0xffffff);
         spotLight.position.set(-20, 30, 10);
         spotLight.castShadow = true;
         scene.add(spotLight);
         
         var pointLight = new THREE.PointLight(0xccffcc);
         pointLight.position.set(-5, 5, 20);
         pointLight.intensity = controls.pointLightIntensity;
         scene.add(pointLight);
         // debug
         //var pointLightAxes = new THREE.AxisHelper(10);
         //pointLight.add(pointLightAxes);
         
         var BOARD_WIDTH = 20;
         var BOARD_HEIGHT = 20;  

         var board_geometry = new THREE.PlaneBufferGeometry(BOARD_WIDTH, BOARD_HEIGHT, 32);
         var board_material = new THREE.MeshLambertMaterial({color: 0xcccccc});
         var board = new THREE.Mesh(board_geometry, board_material);
         //board.receiveShadow = true;
         scene.add(board);

         var snake_group = new THREE.Group();
         board.add(snake_group);

         // https://github.com/mrdoob/three.js/blob/master/examples/canvas_particles_sprites.html
         function particleMaterial(color, width, height) {
             var canvas = document.createElement('canvas');
             canvas.width = width;
             canvas.height = height;
             var context = canvas.getContext('2d');
             var gradient = context.createRadialGradient(width/2, height/2, 0, width/2, height/2, width/2);
             gradient.addColorStop(0, color);
             gradient.addColorStop(0.8, color);
             gradient.addColorStop(0.9, 'rgba(0,0,0,1)');
             gradient.addColorStop(1, 'rgba(0,0,0,0)');
             context.fillStyle = gradient;
             context.fillRect( 0, 0, canvas.width, canvas.height );
             
             return new THREE.SpriteMaterial({
                 map: new THREE.CanvasTexture(canvas)
                     //,blending: THREE.AdditiveBlending
             });
         }

         function explodeMaterial(width, height) {
             var canvas = document.createElement('canvas');
             canvas.width = width;
             canvas.height = height;
             var context = canvas.getContext('2d');
             var gradient = context.createRadialGradient(width/2, height/2, 0, width/2, height/2, width/2);
             gradient.addColorStop(0, 'rgba(255,255,0,1)');
             gradient.addColorStop(1, 'rgba(255,0,0,0)');
             context.fillStyle = gradient;
             context.fillRect( 0, 0, canvas.width, canvas.height );
             
             return new THREE.SpriteMaterial({
                 map: new THREE.CanvasTexture(canvas)
                 ,blending: THREE.AdditiveBlending
             });
         }
         
         // render a snake as an array of particles.  Explode the snake when it dies
         function RenderSnake(board_renderer) {
             this.board_renderer = board_renderer;
             var body_particles = [];
             var material = null;
             
             this.render = function(snake) {
                 if( !material ) {
                     material = particleMaterial(this.board_renderer.game_snake(snake.board_id).color, 32, 32);
                 }
                 
                 var body_points = [];
                 var body_particle_i = 0;
                 var body = snake.body;
                 for(var body_i=0; body_i<snake.body.length-1; body_i++) {
                     var pt0 = this.board_renderer.board_point(body[body_i][0], body[body_i][1], this.board_renderer.cell_width);
                     var pt1 = this.board_renderer.board_point(body[body_i+1][0], body[body_i+1][1], this.board_renderer.cell_width);
                     var NSUBS = 3;
                     for(var subi=0; subi<NSUBS; subi++) {
                         var pt = pt0.clone().lerp(pt1, subi/NSUBS);
                         var particle;
                         if( body_particle_i < body_particles.length ) {
                             particle = body_particles[body_particle_i];
                         }
                         else {
                             particle = new THREE.Sprite(material);
                             body_particles.push(particle);
                             snake_group.add(particle);
                         }
                         body_particle_i++;
                         // TODO: taper the body by scaling it
                         // particle.scale.x = particle.scale.y = Math.random() * 32 + 16;
                         particle.position.copy(pt);
                     }
                 }
                 
                 // remove any leftover body particles
                 for(var i=body_particle_i; i<body_particles.length; i++) {
                     var particle = body_particles[i];
                     snake_group.remove(particle);
                 }
                 if( body_particle_i < body_particles.length ) {
                     body_particles.splice(body_particle_i);
                 }
             }
             
             this.explode = function() {
                 var delay = 0;
                 var dur = 1500;
                 var mag = 20;

                 dur = 750;
                 mag = 5;
                 var explode_material = explodeMaterial(16, 16);
                 new TWEEN.Tween(explode_material)
                          .delay(delay)
                          .to({opacity: .01}, dur)
                          .start();
                 for(var i=0; i<body_particles.length; i++) {
                     var body_particle = body_particles[i];
                     for(var j=0; j<3; j++) {
                         var p0 = body_particle.position;
                         var particle = new THREE.Sprite(explode_material);
                         particle.position.copy(body_particle.position);
                         particle.scale.x = particle.scale.y = Math.random()*4;
                         snake_group.add(particle);
                         new TWEEN.Tween(particle.position)
                                  .delay(delay)
                                  .to({x: p0.x + (Math.random() - 0.5) * mag,
                                       y: p0.y + (Math.random() - 0.5) * mag,
                                       z: p0.z + (Math.random()*mag/2)}, dur)
                                  .start();
                         new TWEEN.Tween(particle.scale)
                                  .delay(delay)
                                  .to({x: 0.01, y: 0.01}, dur)
                                  .onComplete((function(particle) {
                                      return function() {
                                          snake_group.remove(particle);
                                      }
                                  })(particle))
                                  .start();
                     }
                 }

                 // fade out body
                 dur = 1250;
                 mag = 20;
                 new TWEEN.Tween(material)
                          .delay(delay)
                          .to({opacity: .01}, dur)
                          .start();
                 for(var i=0; i<body_particles.length; i++) {
                     var particle = body_particles[i];
                     new TWEEN.Tween(particle)
                              .delay(delay)
                              .to({}, dur)
                              .onComplete((function(particle) {
                                  return function() {
                                      snake_group.remove(particle);
                                  }
                              })(particle))
                              .start();
                 }
                 body_particles = [];
             }

             this.remove = function() {
                 // remove any leftover body particles
                 for(var i=0; i<body_particles.length; i++) {
                     var particle = body_particles[i];
                     snake_group.remove(particle);
                 }
                 body_particles = [];
             }
         }

         function RenderGame() {
             this.board = null;
             this.cell_width = null;
             this.game_snakes = null;

             var render_snakes = Object();
             var snake_infos = Object();
             var food_meshs = [];
             var food_geometry;
             var food_material;

             // the center point of a board cell
             this.board_point = function(cell_x, cell_y, pt_z) {
                 var pt_x = (cell_x + 0.5) * BOARD_WIDTH / this.board.width - BOARD_WIDTH / 2;
                 var pt_y = BOARD_HEIGHT / 2 - (cell_y + 0.5) * BOARD_HEIGHT / this.board.height;
                 return new THREE.Vector3(pt_x, pt_y, pt_z);
             }

             this.game_snake = function(board_id) {
                 return this.game_snakes[board_id];
             }

             this.layout_snake_info = function() {
                 // sort into living and dead
                 var snake_info_killed = [];
                 var snake_info_living = [];
                 for(var board_id in snake_infos) {
                     var snake_info = snake_infos[board_id];
                     if( snake_info.killed ) {
                         snake_info_killed.push(snake_info);
                     }
                     else {
                         snake_info_living.push(snake_info);
                     }
                 }

                 var container = $('#snake-info-list');
                 var pos = container.position();
                 pos.bottom = pos.top + container.innerHeight();
                 var left = pos.left;
                 
                 // killed snakes go from bottom to top
                 snake_info_killed.sort(function(a, b) { return a.turns - b.turns });
                 var y = 0;
                 for(var i=0; i<snake_info_killed.length; i++) {
                     var el = snake_info_killed[i].el();
                     var height = el.outerHeight(true);
                     y += height;
                     var top = pos.bottom - y;
                     var width = container.innerWidth() - parseFloat(el.css('padding-left')) - parseFloat(el.css('padding-right'));
                     el.animate({top: top, left: left, width: width}, 500);
                 }
                 
                 // living snakes go from top to bottom
                 snake_info_living.sort(function(a, b) { return a.order - b.order });
                 y = 0;
                 for(var i=0; i<snake_info_living.length; i++) {
                     var el = snake_info_living[i].el();
                     var height = el.outerHeight(true);
                     var top = pos.top + y;
                     y += height;
                     var width = container.innerWidth() - parseFloat(el.css('padding-left')) - parseFloat(el.css('padding-right'));
                     el.animate({top: top, left: left, width: width}, 500);
                 }
             }

             this.render = function(game_snakes, board) {
                 this.game_snakes = game_snakes;
                 this.board = board;
                 this.cell_width = BOARD_WIDTH / board.width / 2 * .9;

                 if( food_meshs.length > 0 ) {
                     for(var i=food_meshs.length-1; i>=0; i--) {
                         snake_group.remove(food_meshs[i]);
                     }
                     food_meshs = [];
                 }
                 
                 // food!
                 if( !food_geometry ) {
                     food_geometry = new THREE.SphereBufferGeometry(this.cell_width, 8, 8);
                 }
                 if( !food_material ) {
                     food_material = new THREE.MeshLambertMaterial({color: 0xffff00});
                 }
                 for(var food_i=0; food_i<board.food.length; food_i++) {
                     var food = board.food[food_i];
                     var food_mesh = new THREE.Mesh(food_geometry, food_material);
                     food_mesh.position.copy(this.board_point(food[0], food[1], this.cell_width));
                     snake_group.add(food_mesh);
                     food_meshs.push(food_mesh);
                 }

                 // TODO: explode all dead foods

                 // mark all snakes as killed
                 for(var board_id in render_snakes) {
                     if( render_snakes[board_id] ) {
                         render_snakes[board_id].killed = true;
                     }
                 }

                 // re-layout the snake_info blocks
                 var snake_info_layout = false;
                 
                 function get_snake_info(board_id) {
                     var snake_info = snake_infos[board_id];
                     if( !snake_info ) {
                         var snake_info_id = "snake-info-" + board_id;
                         snake_info = new SnakeInfoBlock(snake_info_id);
                         snake_info.order = snake_i;
                         snake_infos[board_id] = snake_info;
                         snake_info_layout = true;
                     }
                     return snake_info;
                 }

                 // render living snakes
                 for(var snake_i=0; snake_i<board.snakes.length; snake_i++) {
                     var snake = board.snakes[snake_i];
                     var render_snake = render_snakes[snake.board_id];
                     if( !render_snake ) {
                         render_snake = new RenderSnake(this);
                         render_snakes[snake.board_id] = render_snake;
                     }
                     render_snake.render(snake);
                     render_snake.killed = false;

                     var snake_info = get_snake_info(snake.board_id);
                     if( snake_info.killed ) {
                         snake_info.killed = false;
                         snake_info_layout = true;
                     }
                     snake_info.set(game_snakes[snake.board_id]);
                     snake_info.set(snake);
                 }

                 // update killed snake_infos
                 for(var snake_i=0; snake_i<board.killed.length; snake_i++) {
                     var snake = board.killed[snake_i];
                     var snake_info = get_snake_info(snake.board_id);
                     if( !snake_info.killed ) {
                         snake_info.killed = true;
                         snake_info_layout = true;
                         snake_info.set(snake);
                     }
                 }
                 
                 // explode killed snakes
                 for(var board_id in render_snakes) {
                     var render_snake = render_snakes[board_id];
                     if( render_snake.killed ) {
                         render_snake.explode();
                         delete render_snakes[board_id];

                         var snake_info = snake_infos[board_id];
                         if( snake_info ) {
                             snake_info.killed = true;
                             snake_info_layout = true;
                         }
                     }
                 }
                 
                 // re-layout snake_infos
                 if( snake_info_layout ) {
                     this.layout_snake_info();
                 }
             }

             this.resize = function () {
                 this.render();
             }

         }
         

         var GAME_FPS = 30;
         var game_list_index = -1;
         var game_dirty = false;
         var game_turn_index = -1;
         var game_turn_data;
         var game_snakes;
         var game_playing = true;
         var game_render;
         
         $("#play_slider").slider({
             slide: function(event, ui) {
                 seek(ui.value);
             }
         });

         $("#play_button").button({
             icons: { primary: 'ui-icon-play'}
         }).change(function () {
             play($(this).is(':checked'));
         });

         function play(playing) {
             game_playing = playing;
             if( playing ) {
                 game_dirty = true;
             }
         }

         function seek(pos) {
             if( game_turn_data ) {
                 game_turn_index = pos;
                 game_dirty = true;
             }
         }
         
         function load_games_table(games) {
             var rowData = [];
             for(var i=0; i<games.length; i++) {
                 var row = [
                     games[i].turns,
                     games[i].generation,
                     games[i].game,
                     "",
                 ];
                 rowData.push(row)
             }
             
             var table;
             table = $('#games_table').DataTable({
                 select:         true,
                 scrollY:        "800px",
                 scrollX:        true,
                 scrollCollapse: true,
                 paging:         false,
                 searching:      false,
                 order:          [[ 0, "desc" ]],
                 data:           games,
                 columns: [
                     { title: "Turns",      data: "turns", className: "dt-body-right" },
                     { title: "Generation", data: "generation", className: "dt-body-right" },
                     { title: "Game",       data: "game", className: "dt-body-right" },
                     { title: "Func Size",  data: "func_size", className: "dt-body-right" }
                 ],
                 fnInitComplete: function(oSettings, json) {
                     setTimeout(function() {
                         table.row(':eq(0)', { page: 'current' }).select();
                         //$('#games_table tbody tr:eq(0)').select();
                         }, 100);
                 }
             });
             table.on('select', function(e, dt, type, indexes) {
                 if( type == 'row' ) {
                     var path = table.rows(indexes).data().pluck('path')[0];
                     load_game("training/" + path);
                 }
             } );
         }
         
         function load_games_list(url) {
             // load the game.  When loaded, set game_dirty
             $.getJSON(url, function(data) {
                 // load games into table
                 load_games_table(data);
             });
         }
         load_games_list("training/games.json");

         function stringToColour(str) {
             var hash = 0;
             for (var i = 0; i < str.length; i++) {
                 hash = str.charCodeAt(i) + ((hash << 5) - hash);
             }
             var colour = '#';
             for (var i = 0; i < 3; i++) {
                 var value = (hash >> (i * 8)) & 0xFF;
                 colour += ('00' + value.toString(16)).substr(-2);
             }
             return colour;
         }
         
         function load_game(url) {
             // load the game.  When loaded, set game_dirty
             $.getJSON(url, function(data) {
                 game_data = data;
                 game_turn_data = data["turns"];
                 game_turn_index = 0;
                 game_dirty = true;

                 $("#play_slider").slider("option", "max", game_turn_data.length - 1);

                 snakes = data["snakes"];
                 game_snakes = Object();
                 for(var i=0; i<snakes.length; i++) {
                     var snake = snakes[i];
                     if( !snake.color ) {
                         snake.color = stringToColour(snakes[i].func);
                     }
                     if( !snake.taunt ) {
                         snake.taunt = snake.func;
                     }
                     game_snakes[snake.board_id] = snakes[i];
                 }
             });
         }
         
         function game_update_timer() {
             // after rendering, set the timer to render the next frame
             game_turn_index += 1;
             if( game_turn_index >= game_turn_data.length ) {
                 // TODO - load next game
                 game_turn_index = 0;
             }
             game = game_turn_data[game_turn_index];
             game_dirty = true;
         }

         function render() {
             var t0 = performance.now();
             var delta = clock.getDelta();
             trackballControls.update(delta);
             TWEEN.update();
                 
             if( game_dirty ) {
                 if( !game_render ) {
                     game_render = new RenderGame();
                 }
                 game_render.render(game_snakes, game_turn_data[game_turn_index]);
                 $("#play_slider").slider("value", game_turn_index);
                 game_dirty = false;
                 if( game_playing ) {
                     var next_dt = 1000.0 / GAME_FPS - (performance.now() - t0);
                     if(  next_dt < 0 ) {
                         next_dt = 0;
                     }
                     setTimeout(game_update_timer, next_dt);
                 }
             }
             renderer.render(scene, camera);
             requestAnimationFrame(render);
         }
         
         resize();
         document.getElementById("scene_pane").appendChild(renderer.domElement);
         render();
     }
     window.onload = init;

     function resize() {
         $('#main_pane').width(window.innerWidth).height(window.innerHeight).split({
             orientation: 'vertical',
             limit: 10,
             position: '60%', // if there is no percentage it interpret it as pixels
             onDrag: function(event) {
                 resize();
             }
         });

         $('#board_pane').width($('#board_pane').innerWidth).height(window.innerHeight).split({
             orientation: 'horizontal',
             limit: 10,
             position: window.innerHeight-200,
             onDrag: function(event) {
                 resize();
             }
         });

         if( camera && renderer ) {
             var scene_pane = $("#scene_pane");
             var w = scene_pane.innerWidth();
             var h = scene_pane.innerHeight();
             camera.aspect = w / h;
             camera.updateProjectionMatrix();
             renderer.setSize(w, h);
         }
     }
     
     window.addEventListener('resize', resize, false);

     
    </script>
  </body>
</html>
